<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/ros-action-client/ros-action-client.html">

<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/ros-service/ros-service.html">
<link rel="import" href="../../bower_components/ros-topic/ros-topic.html">
<link rel="import" href="../../bower_components/ros-rviz/ros-rviz.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../underscore.html">

<dom-module id="pbd-new-problem">
  <template>
    <style include="shared-styles"></style>
    <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
        height: 100%;
      }

      .paper-material {
        margin-top: 5px;
      }

      a {
        color: #000;
        text-decoration: none;
      }

      .add {
        height: 25px;
        padding: 5px 5px;
        line-height: 14px;
        margin-bottom: 5px;
      }

      paper-input {
        width: 40%;
        display: inline-block;
      }

      paper-dropdown-menu {
        max-width: 100px;
        margin-left: 10px;
        margin-top: 0px;
        text-align: center;
      }

      .runstop {
        color: #fff;
        margin-left: 10px;
        height: 40px;
      }

      .run {
        background-color: var(--paper-green-500);
      }

      .stop {
        background-color: var(--paper-red-500);
      }

      .stepDiv {
        min-width: 550px;
        margin-bottom: 10px;
        /*overflow-y: auto;*/
        padding-left: 2px;
        padding-right: 2px;
        padding-bottom: 2px;
        display: inline-block;
      }

      #rviz {
        display: block;
        min-height: 500px;
      }

      fieldset>p {
        display: inline-block;
        margin-top: 5px;
      }

      fieldset iron-icon {
        display: inline-block;
        vertical-align: top;
        margin-top: 5px;
      }

      .delete {
        font-size: 80%;
        padding: 0;
        width: 5px;
        color: red;
        flex: 1;
      }

      .petit {
        font-size: 80%;
        margin: 0;
        margin-left: 5px;
        color: steelblue;
      }

      @media (min-width: 468px) {
        #layout {
          height: 100%;
        }
        .content {
          @apply(--layout-horizontal);
          @apply(--layout-flex);
        }
        .stepDiv {
          min-width: 500px;
          max-height: 100%;
          margin-bottom: 0px;
          margin-right: 10px;
        }
        #rviz {
          min-height: 350px;
          max-width: 500px;
          @apply(--layout-flex);
        }

        .button_not {
          vertical-align: bottom;
          padding-bottom: 9px;
          padding-left: 6px;
        }
      }


      header {
        display: flex;
      }

      nav {
        font-size: 1.2em;
        text-align: center;
        flex: 1;
      }

      #problemName {
        width: 200px;
      }

      nav paper-button {
        border: 1px solid rgb(138, 125, 125);
        border-radius: 10px;
      }

      paper-dialog {
        border-radius: 5px;
      }

      paper-button.cancel {
        color: rgb(255, 68, 68);
      }

      #buttonDiv {
        float: right;
      }

      header {
        padding: 10px;
      }

      .important {
        width: 30px;
        height: 30px;
      }

      .listeWorldState {
        display: flex;
        border-bottom: 1px solid rgba(0, 0, 0, var(--light-divider-opacity));
      }

      .listeWorldState p {
        flex: 2;
        margin: 1px;
      }
    </style>
    <app-route route="{{route}}" pattern="/:id" data="{{routeData}}"></app-route>
    <ros-topic auto id="eventPub" msg-type="rapid_pbd_msgs/EditorEvent" topic="rapid_pbd/editor_events" ros="[[ros]]"></ros-topic>
    <!-- PDDL -->
    <ros-topic id="domainTopic" auto last-message="{{pddlDomain}}" msg-type="rapid_pbd_msgs/PDDLDomain" topic="rapid_pbd/domain/{{domain_id}}"
      ros="[[ros]]"></ros-topic>
    <ros-topic auto last-message="{{domain_msg}}" msg-type="std_msgs/String" topic="rapid_pbd/pddl_domain" ros="[[ros]]"></ros-topic>
    <ros-action-client id="programAction" ros="[[ros]]" server="/rapid_pbd/execute_program_action" action-type="rapid_pbd_msgs/ExecuteProgramAction"
      on-feedback="_handleFeedback" on-result="_handleResult"></ros-action-client>

    <header>
      <paper-input id="problemName" label="Problem name" value="{{problemName}}" auto-validate pattern="[a-zA-Z0-9_-]*" error-message="invalid characters"></paper-input>
      <nav>
        <!-- Action navigation buttons -->
        <paper-button class="petit" name="perception" on-tap="_selectNavStep" disabled$="[[_displayNavStep(navStep,'perception')]]"
          data-args="perception">
          1. Initial State
        </paper-button>
        <paper-button name="problemModel" class="petit" on-tap="_selectNavStep" disabled$="[[_displayNavStep(navStep,'problemModel')]]"
          data-args="problemModel">
          2. Goal State
        </paper-button>
        <paper-button class="petit" name="generatedPlan" on-tap="_selectNavStep" disabled$="[[_displayNavStep(navStep,'generatedPlan')]]"
          data-args="generatedPlan">
          3. Generated Plan
        </paper-button>
      </nav>
      <div id="buttonDiv">

        <paper-button raised class="clear" on-tap="_refreshViz">
          <iron-icon icon="icons:refresh"> </iron-icon>
        </paper-button>
        <paper-button raised class="clear" on-click="saving">
          <iron-icon icon="icons:save"> </iron-icon>
          Save
        </paper-button>
        <paper-button raised class="clear" on-click="exiting">
          <iron-icon icon="icons:close"> </iron-icon>
        </paper-button>

      </div>

      <paper-dialog modal id="saving">
        <h2>Save current problem ?</h2>
        <p>If problem name changed, please reopen problem after save.</p>
        <div>
          <paper-button dialog-dismiss raised class="cancel">Cancel</paper-button>
          <paper-button dialog-confirm raised on-tap="save">Save</paper-button>
        </div>
      </paper-dialog>
      <paper-dialog modal id="exiting">
        <h2>Quit current problem ?</h2>
        <p>All change not saved will be lost.</p>
        <div>
          <paper-button dialog-dismiss raised class="cancel">Cancel</paper-button>
          <paper-button dialog-confirm raised on-tap="quit">Quit</paper-button>
        </div>
      </paper-dialog>
    </header>

    <div id="layout" class="layout vertical">

      <div class="content">
        <div id="stepContent" class="stepDiv">
          <!-- ***** Initial State **** 1/3 -->
          <div id="perception" hidden$="[[!_displayNavStep(navStep,'perception')]]">
            <fieldset>
              <legend>
                Detected World Objects
              </legend>
              <!-- <p>Verify all objects have been detected before proceeding.</p> -->
              <p id="noObj">No objects detected
                <br>
              </p>
              <template is="dom-repeat" items="{{sortByName(problem.objects)}}" as="item" index-as="paramIndex">

                <div id="listeObjet" class="petit">
                  <paper-dropdown-menu no-label-float>
                    <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{item.type.name}}">
                      <template is="dom-repeat" items="[[_getTypes(item)]]" as="item2" index-as="typeIndex">
                        <paper-item name="[[item2]]" on-tap="_updateType" data-args="[[item]]">[[item2]]</paper-item>
                      </template>
                    </paper-listbox>
                  </paper-dropdown-menu>
                  <font size="2pt" color="grey">([[item.name]])</font>
                </div>
              </template>

              <paper-button id="detect" raised class="clear" on-tap="_detect" data-args="initial">
                <iron-icon icon="icons:find-in-page"> </iron-icon>
                Detect World Objects
              </paper-button>
            </fieldset>

            <fieldset>
              <legend>
                Initial States
              </legend>
              <template is="dom-repeat" items="{{problem.initial_states}}" as="item" index-as="objectIndex">
                <div class="listeWorldState">
                  <p>
                    [[item.arg1.name]] ([[_getParamTypeByName(item.arg1)]])
                  </p>
                  <p>
                    is [[_negate(item.negate)]] [[item.name]] [[item.arg2.name]]
                  </p>
                  <!-- <paper-icon-button on-tap="" icon="create"></paper-icon-button> -->
                  <paper-icon-button class="delete" on-tap="deletePred" data-args="InitialState" icon="delete"></paper-icon-button>
                </div>
              </template>

              <div>
                <paper-dropdown-menu id="menu_instance1_precond" label="Element 1">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newInitialState.arg1}}">
                    <template is="dom-repeat" items="[[problem.objects]]">
                      <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newInitialState.arg1">
                        [[item.name]]
                      </paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                <paper-radio-button class="button_not" id="button_not_precond">not</paper-radio-button>
                <paper-dropdown-menu id="menu_name_precond" label="Predicate">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newInitialState.name}}">
                    <template is="dom-repeat" items="[[domain.predicates]]">
                      <paper-item name="[[item.name]]" on-tap="_updatePredicate" data-args="newInitialState.predicate.name">is [[item.name]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                <paper-dropdown-menu id="menu_instance2_precond" label="Element 2">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newInitialState.arg2}}">
                    <template is="dom-repeat" items="[[problem.objects]]">
                      <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newInitialState.arg2">
                        [[item.name]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                <paper-icon-button icon="icons:add-circle-outline" on-tap="addPredicate" data-args="InitialState"></paper-icon-button>
              </div>

              <!-- <paper-button id="next" raised class="clear" on-tap="_selectNavStep" data-args="problemModel">
                Next
              </paper-button> -->
            </fieldset>
            <div>
              <paper-dropdown-menu id="menu_type1" label="Type 1">
                <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newInitialState.arg1}}">
                  <template is="dom-repeat" items="[[domain.types]]">
                    <paper-item name="[[item]]" on-tap="" data-args="newInitialState.arg1">
                      [[item.name]]
                    </paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-radio-button class="button_not" id="button_not_type">not</paper-radio-button>
              <paper-dropdown-menu id="menu_type_pred" label="Predicate">
                <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newInitialState.name}}">
                  <template is="dom-repeat" items="[[domain.predicates]]">
                    <paper-item name="[[item.name]]" on-tap="" data-args="newInitialState.predicate.name">is [[item.name]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-dropdown-menu id="menu_type2" label="Type 2">
                <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newInitialState.arg2}}">
                  <template is="dom-repeat" items="[[domain.types]]">
                    <paper-item name="[[item]]" on-tap="" data-args="newInitialState.arg2">
                      [[item.name]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-icon-button icon="icons:add-circle-outline" on-tap="addPredicate" data-args="InitialState"></paper-icon-button>
            </div>

            <paper-button on-tap="[[_addStackable('object','position','stackable')]]">Objects on Positions</paper-button>
          </div>

          <!-- ***** Goal States **** 2/3 -->
          <div id="problemModel" hidden$="[[!_displayNavStep(navStep,'problemModel')]]">
            <fieldset>
              <legend>
                Goal States
              </legend>
              <p id="noGoals" hidden$="[[_hasGoals]]">Defined goal states to achieve:

              </p>
              <template is="dom-repeat" items="{{problem.goal_states}}" as="item" index-as="objectIndex">
                <div class="listeWorldState">
                  <p>
                    [[item.arg1.name]] ([[_getParamTypeByName(item.arg1)]])
                  </p>
                  <p>
                    is [[_negate(item.negate)]] [[item.name]] [[item.arg2.name]]
                  </p>
                  <!-- <paper-icon-button on-tap="" icon="create"></paper-icon-button> -->
                  <paper-icon-button class="delete" on-tap="deletePred" data-args="InitialState" icon="delete"></paper-icon-button>
                </div>
              </template>

              <div>
                <paper-dropdown-menu id="menu_instance1_goal_state" label="Element 1">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newGoalState.arg1}}">
                    <template is="dom-repeat" items="[[problem.objects]]">
                      <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newGoalState.arg1">
                        [[item.name]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                <paper-radio-button class="button_not" id="button_not_goal_state">not</paper-radio-button>
                <paper-dropdown-menu id="menu_name_goal_state" label="Predicate">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newGoalState.name}}">
                    <template is="dom-repeat" items="[[domain.predicates]]">
                      <paper-item name="[[item.name]]" on-tap="_updatePredicate" data-args="newGoalState.predicate.name">is [[item.name]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                <paper-dropdown-menu id="menu_instance2_goal_state" label="Element 2">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newGoalState.arg2}}">
                    <template is="dom-repeat" items="[[problem.objects]]">
                      <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newGoalState.arg2">
                        [[item.name]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                <paper-icon-button raised icon="icons:add-circle-outline" on-tap="addPredicate" data-args="GoalState"></paper-icon-button>

              </div>
              <br>
              <center>
                <paper-button id="solve" raised class="clear" on-tap="_solve" data-args="">
                  <iron-icon icon="icons:lightbulb-outline"></iron-icon>
                  Solve Problem
                </paper-button>
              </center>
            </fieldset>

          </div>

          <!-- ***** Generated Plan **** 3/3 -->
          <div id="plan" hidden$="[[!_displayNavStep(navStep,'generatedPlan')]]">
            <fieldset>
              <legend>
                Generated steps to solve problem
              </legend>
              <!-- <p>Verify all sequence is correct before proceeding.</p> -->
              <p id="noSteps" hidden$="[[!_stepsFound]]">No steps generated. Definitions are missing.</p>
              <table>
                <template is="dom-repeat" items="{{problem.sequence}}" as="item" index-as="stepIndex">
                  <tr>
                    <div id="listSteps">
                      <td>
                        <b>Action {{displayIndex(stepIndex)}}:</b>
                      </td>
                      <td>[[_parseArgs(item)]]</td>
                      <!-- <td>
                        
                        <paper-button class="delete" on-tap="deletePlanStep">
                          <paper-icon-button icon="delete"></paper-icon-button>
                        </paper-button>
                      </td> -->
                    </div>
                  </tr>
                </template>
              </table>
              <!-- Add new action to plan manually -->
              <!-- <div>
                <paper-dropdown-menu id="menu_plan_step_action" label="Action">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name">
                    <template is="dom-repeat" items="[[domain.actions]]">
                      <paper-item name="[[item]]" on-tap="_updatePlanStep" data-args="action">
                        [[item.name]]
                      </paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                 Action parameters -->
              <!-- <paper-dropdown-menu id="menu_plan_step_arg1" label="Arg 1">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name">
                    <template is="dom-repeat" items="[[problem.objects]]">
                      <paper-item name="[[item]]" on-tap="_updatePlanStep" data-args="arg1">
                        [[item.name]]
                      </paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                <paper-dropdown-menu id="menu_plan_step_arg2" label="Arg 2">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name">
                    <template is="dom-repeat" items="[[problem.objects]]">
                      <paper-item name="[[item]]" on-tap="_updatePlanStep" data-args="arg2">
                        [[item.name]]
                      </paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                <paper-dropdown-menu id="menu_plan_step_arg3" label="Arg 3">
                  <paper-listbox slot="dropdown-content" attr-for-selected="name">
                    <template is="dom-repeat" items="[[problem.objects]]">
                      <paper-item name="[[item]]" on-tap="_updatePlanStep" data-args="arg3">
                        [[item.name]]
                      </paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
              </div>
              <br>
              <paper-button noink class="petit" on-click="addPlanStep" data-args="addPlanStep">+ add action step</paper-button> -->

              <center>
                <paper-button id="execute" raised class="clear" on-tap="_execute">
                  Execute plan
                </paper-button>
              </center>
              <paper-button noink class="petit" on-click="showDebugging">
                <iron-icon icon="icons:lightbulb-outline"></iron-icon>
                Follow Hints
              </paper-button>
              <div id="debugging" hidden$="[[!_showDebugging]]">
                <p id="verifyInitialStates">
                  <b>Hint 1: Review initial states:</b>
                  <paper-button class="clear" on-tap="viewInitialStates">
                    <paper-icon-button icon="icons:find-in-page"></paper-icon-button>
                  </paper-button>
                  <p id="initalStatesSummary">
                    <!-- <fieldset> -->
                    <p id="msgInitalStatesSummary" style="padding: 5px"></p>
                    <!-- </fieldset> -->
                  </p>
                </p>
                <p id="verifyGoalStates">
                  <b>Hint 2: Review goal states:</b>
                  <paper-button class="clear" on-tap="viewGoalStates">
                    <paper-icon-button icon="icons:find-in-page"></paper-icon-button>
                  </paper-button>
                  <p id="goalStatesSummary">
                    <!-- <fieldset> -->
                    <p id="msgGoalStatesSummary" style="padding: 5px"></p>

                    <!-- </fieldset> -->
                  </p>
                </p>
                <p id="verifyActions">
                  <h4>Hint 3: Make sure actions can achieve goal state:</h4>
                  <template is="dom-repeat" items="[[domain.actions]]" as="action">
                    <i> [[_getGeneralisedAction(action)]]</i>
                    <paper-button class="clear" on-tap="viewActionSummary" data-args="[[action]]">
                      <paper-icon-button icon="icons:find-in-page"></paper-icon-button>
                    </paper-button>
                    <br>
                  </template>
                  <p id="actionSummary">
                    <fieldset>
                      <p id="msgActionSummary" style="padding: 5px"></p>

                    </fieldset>
                  </p>
                </p>
              </div>
            </fieldset>
          </div>
        </div>
        <ros-rviz id="rviz" ros="[[ros]]" hidden$="[[_displayNavStep(navStep,'generatedPlan')]]"></ros-rviz>
      </div>
    </div>
    <paper-dialog id="errorDialog" modal>
      <h2>Error running the program</h2>
      <p>[[error]]</p>
      <div class="buttons">
        <paper-button dialog-confirm class="clear">OK</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog id="errorNewPrecond">
      <h2>Error creating new initial_state</h2>
      <p id="msgErrorNewPrecond">An error has been encountered ...</p>
      <div class="buttons">
        <paper-button dialog-confirm class="clear">OK</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog id="errorNewGoalState">
      <h2>Error creating new goal_state</h2>
      <p id="msgErrorNewGoalState">An error has been encountered ...</p>
      <div class="buttons">
        <paper-button dialog-confirm class="clear">OK</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog modal id="loading">
      <p>
        <paper-spinner-lite active></paper-spinner-lite> Detecting objects on the table</p>
    </paper-dialog>
  </template>

  <script>
    Polymer({
      is: 'pbd-new-problem',
      properties: {
        navStep: {
          type: String,
          value: "perception"
        },
        problem: Object,
        domain: Object,
        domain_id: String,
        domain_msg: {
          type: Object,
          value: function () {
            return { data: false };
          }
        },
        params: Object,
        planner: {
          type: String,
          value: "ff"
        },
        program: {
          type: Object,
          observer: '_programChanged',
        },
        ros: Object,
        route: Object,
        isRunning: {
          type: Object,
          value: function () {
            return { data: false };
          }
        },
        pddlDomain: {
          type: Object,
          value: function () {
            return { problems: [] };
          }
        },
        newInitialState: {
          type: Object,
          value: function () {
            return {
              arg1: Object,
              name: '',
              arg2: Object,
              negate: false,
            };
          }
        },
        newGoalState: {
          type: Object,
          value: function () {
            return {
              action: '',
              args: [],
            };
          }
        },
        newPlanStep: {
          type: Object,
          value: function () {
            return {
              action: '',
              args: ['', '', '']
            };
          }
        },
        problemName: String,
        newDetect: {
          type: Boolean,
          value: true,
        },
        _stepsFound: {
          type: Boolean,
          value: true,
        },
        _showDebugging: {
          type: Boolean,
          value: false,
        },
        _hasGoals: {
          type: Boolean,
          value: function () {
            return false;
          },
        },
        // lastDomainUpdated: {
        //   type: CustomEvent,
        //   observer: '_getAllStates',
        // },
        // showRobotModel: {
        //   type: Boolean,
        //   value: false,
        // },
      },

      observers: [
        'load(domain_id, params.*,domain_msg.data)',
        '_domainUpdated(pddlDomain.*)',
        '_problemUpdated(problem.*)',
        // '_checkClearPos(newInitialState.arg1.type,newGoalState.arg1.type)',
        '_checkClearPrecond(newInitialState.name)',
        '_checkClearGoalState(newGoalState.name)',
        // '_getAllStates(lastDomainUpdated)'
      ],

      _checkClearPos: function (type) {
        // TO DO: not sure if the added predicate is valid
        if (type && type.name == "position") {
          this.newInitialState.name = "is clear";
          this.$.menu_instance2_precond.disabled = true;
          this.$.menu_instance2_precond.value = undefined;
          this.$.menu_name_precond.value = "is clear";
          this.newInitialState.arg2 = undefined;
        } else {
          //this.$.menu_instance2_precond.disabled = false;
        }
      },
      _checkClearPrecond: function (nom_precond) {
        if (nom_precond == "clear" || nom_precond == "thin" || nom_precond == "flat") {
          this.$.menu_instance2_precond.disabled = true;
          this.$.menu_instance2_precond.value = undefined;
          this.newInitialState.arg2 = undefined;
        } else {
          this.$.menu_instance2_precond.disabled = false;
        }
      },
      _checkClearGoalState: function (nom_goal_state) {
        if (nom_goal_state == "clear" || nom_goal_state == "thin" || nom_goal_state == "flat") {
          this.$.menu_instance2_goal_state.disabled = true;
          this.$.menu_instance2_goal_state.value = undefined;
          this.newGoalState.arg2 = undefined;
        } else {
          this.$.menu_instance2_goal_state.disabled = false;
        }
      },
      _problemUpdated: function (problem) {
        if (problem && problem.base && problem.base.name != '') {
          this.problemName = problem.base.name;
        }
      },

      load: function (db_id, paramsChangeRecord) {
        if (this.problem.scene_id) {
          this.scene_id = this.problem.scene_id;
        } else {
          this.scene_id = "";
        }
        if (!this.domain_id && changedMsg) {
          console.log("set domain_id to: ", changedMsg);
          this.domain_id = changedMsg;
        }
        if (!this.params.robot) {
          return;
        }
        var depthCloudFrameId = '';
        if (this.params.robot === "pr2") {
          depthCloudFrameId = '/head_mount_kinect_rgb_optical_frame';
        } else if (this.params.robot === "fetch") {
          depthCloudFrameId = '/head_camera_rgb_optical_frame';
        } else if (this.params.robot === "baxter") {
          depthCloudFrameId = '/camera_rgb_optical_frame';
        } else {
          console.error('Unknown robot type', this.params.robot);
        }

        var fixedFrame = '';
        if (this.params.robot === "pr2" || this.params.robot === "fetch") {
          fixedFrame = '/base_link';
        } else if (this.params.robot === "baxter") {
          fixedFrame = '/base';
        } else {
          console.error('Unknown robot type', this.params.robot);
        }
        if (this.problem) {
          db_id = this.problem.generated_plan;
        }
        var config = {
          globalOptions: {
            background: '#113344',
            colladaLoader: 'collada2',
            colladaServer: window.location.protocol + '//' + window.location.hostname + ':8001/',
            fixedFrame: fixedFrame,
            videoServer: window.location.protocol + '//' + window.location.hostname + ':9998',
            url: 'ws://' + window.location.hostname + ':9090'
          },
          displays: [
            {
              //   isShown: false,
              //   name: 'Grid',
              //   type: 'grid',
              //   options: {
              //     cellSize: 1,
              //     color: '#cccccc',
              //     numCells: 20,
              //   },
              // }, {
              //   isShown: false,
              //   name: 'Program robot model',
              //   type: 'markerArray',
              //   options: {
              //     topic: '/rapid_pbd/robot/' + this.scene_id,
              //   },
              // }, {
              isShown: true,
              name: 'Surface segmentation',
              type: 'markerArray',
              options: {
                topic: '/rapid_pbd/surface_segmentation/' + this.scene_id,
              },
              // }, {
              //   isShown: true,
              //   name: 'Surface segmentation',
              //   type: 'markers',
              //   options: {
              //     topic: '/rapid_pbd/surface_seg/visualization,
              //   },
            }, {
              isShown: true,
              name: 'Scene',
              type: 'pointCloud2',
              options: {
                size: 0.01,
                topic: '/rapid_pbd/scene/' + this.scene_id,
              },
              // }, {
              //   isShown: false,
              //   name: 'Current robot model',
              //   type: 'urdf',
              //   options: {
              //     param: 'robot_description',
              //     tfPrefix: ''
              //   },
              // }, {
              //   isShown: false,
              //   name: 'Current surface segmentation',
              //   type: 'markerArray',
              //   options: {
              //     topic: '/rapid_pbd/runtime_segmentation',
              //   },
              // }, {
              //   isShown: false,
              //   name: 'Current depth cloud',
              //   type: 'depthCloud',
              //   options: {
              //     topic: 'depthcloud_encoded',
              //     frameId: depthCloudFrameId
              //   },
            },
          ],
          sidebarOpened: false,
        };
        if (this.$.rviz) {
          this.$.rviz.config = config;
        } else {
          console.info('rviz not ready');
        }

      },
      _addStackable: function () {

      },
      _addForAllPredicates: function (type1, type2, predicate) {
        // loops through objects and adds predicates that are consistent with the given types
        // so far only for is stackable
        console.debug("_addForAllPredicates: objs", this.problem.objects);
        for (var i = 0; i < this.problem.objects.length; ++i) {
          var param1 = this.problem.objects[i];
          console.debug("_addForAllPredicates: param1", param1);
          if (param1.type.name == type1) {
            for (var j = 0; j < this.problem.objects.length; ++j) {
              var param2 = this.problem.objects[j];
              console.debug("_addForAllPredicates: param2", param2);
              if (param2.type.name == type2) {
                this.problem.initial_states.push({
                  arg1: param1,
                  name: predicate,
                  arg2: param2,
                  negate: false
                });
              }
            }
          }
        }
      },
      _updatePredicate: function (evt) {
        var args = evt.target.getAttribute('data-args');
        this.set(args, evt.target.name);
        console.debug(args, ' is ', this.newInitialState);
      },
      checkPredicate: function (mode, _new) {
        var newPredicate = _new;
        var valide = true;
        var index = 0;
        // msgErreur explains why the precond isn't valid
        var msgErreur = "";

        if (mode == "initial_state") {
          var liste = this.problem.initial_states;
          // Check if items are well selected
          if (this.$.menu_instance1_precond.value == undefined
            || this.$.menu_name_precond.value == undefined
            || ((this.$.menu_name_precond.value != "is clear"
              && this.$.menu_name_precond.value != "is thin"
              && this.$.menu_name_precond.value != "is flat")
              && this.$.menu_instance2_precond.value == undefined)) {
            valide = false;
            msgErreur = "Complete your new predicate before adding it";
          }
        } else {
          var liste = this.problem.goal_states;
          // Check if items are well selected
          if (this.$.menu_instance1_goal_state.value == undefined
            || this.$.menu_name_goal_state.value == undefined
            || ((this.$.menu_name_precond.value != "is clear"
              && this.$.menu_name_precond.value != "is thin"
              && this.$.menu_name_precond.value != "is flat")
              && this.$.menu_instance2_goal_state.value == undefined)) {
            valide = false;
            msgErreur = "Complete your new predicate before adding it";
          }
        }

        if (valide) {
          // Without negation
          if (!newPredicate.negate) {
            // To comment when you want to test else it's impossible to test on simulation                            
            if (newPredicate.arg1.type.name == "position"
              && (newPredicate.name == "on" || newPredicate.name == "stackable")) {
              valide = false;
              msgErreur = "A position can never be stacked on something else"
            }
            else if ((newPredicate.name == "on" || newPredicate.name == "stackable")
              && newPredicate.arg1.name == newPredicate.arg2.name) {
              valide = false;
              msgErreur = "An object can never be stacked on itself";
            }

            while (valide && index < liste.length) {
              if (newPredicate.name == liste[index].name
                && (newPredicate.name == "clear"
                  || newPredicate.name == "flat"
                  || newPredicate.name == "thin")
                && newPredicate.arg1.name == liste[index].arg1.name) {
                valide = false;
                msgErreur = "This " + mode + " exists already";
              }
              else if (newPredicate.name == liste[index].name
                && newPredicate.arg1.name == liste[index].arg1.name
                && newPredicate.arg2.name == liste[index].arg2.name) {
                valide = false;
                msgErreur = "This " + mode + " exists already";
              }
              else if (newPredicate.name == "on" && liste[index].name == "on") {
                if (newPredicate.arg2.name == liste[index].arg2.name) {
                  valide = false;
                  msgErreur = "You can't place two objects on one position, see :<br><strong>" + liste[index].arg1.name + liste[index].name + liste[index].arg2.name + "</strong>";
                } else if (newPredicate.arg1.name == liste[index].arg1.name) {
                  valide = false;
                  msgErreur = "One object can't be placed on two positions, see :<br><strong>" + liste[index].arg1.name + liste[index].name + " " + liste[index].arg2.name + "</strong>";
                }
              }
              else if (newPredicate.name == "clear"
                && (liste[index].name == "on"
                  && liste[index].arg2.name == newPredicate.arg1.name)) {
                valide = false;
                msgErreur = "It is not possible to be clear and to have something on it at the same time, see :<br><strong>" + liste[index].arg1.name + "is " + liste[index].name + " " + liste[index].arg2.name + "</strong>";
              }
              else if (liste[index].name == "clear"
                && (newPredicate.name == "on"
                  && newPredicate.arg2.name == liste[index].arg1.name)) {
                valide = false;
                msgErreur = "It is not possible to be clear and to have something on it at the same time, see :<br><strong>" + liste[index].arg1.name + " is " + liste[index].name + "</strong>";
              }
              index++;
            }
            // With negation
          } else {

          }
        }
        return { valid: valide, msg: msgErreur };
      },

      deletePlanStep: function (evt) {
        var item = evt.model.item;
        console.debug('deletePlanStep', item);
        var index = -1;
        index = this.problem.sequence.indexOf(item);
        if (index != -1) {
          this.splice('problem.sequence', index, 1);
          this.reevaluateArray('problem.sequence', this.problem.sequence);
          console.debug('deleted action ', index, ' from solution sequence');
        }
      },
      _updatePlanStep: function (evt) {
        var args = evt.target.getAttribute('data-args');
        if (args == "action")
          this.set("newPlanStep.action", evt.target.name.name);
        if (args == "arg1")
          this.newPlanStep.args[0] = evt.target.name.name;
        if (args == "arg2")
          this.newPlanStep.args[1] = evt.target.name.name;
        if (args == "arg3")
          this.newPlanStep.args[2] = evt.target.name.name;
        console.debug(args, ' is ', this.newPlanStep);
      },
      addPlanStep: function (evt) {
        this.problem.sequence.push(this.newPlanStep);
        this.reevaluateArray('problem.sequence', this.problem.sequence);
        console.debug('added action to solution sequence:', this.problem.sequence);

      },
      addPredicate: function (evt) {
        var condition = evt.target.getAttribute('data-args');
        if (condition == "InitialState") {
          // Check if the NOT-button is checked or no and update it
          this.newInitialState.negate = this.$.button_not_precond.checked;
          this.$.button_not_precond.checked = false;

          var check = this.checkPredicate("initial_state", this.newInitialState);
          if (check.valid) {
            // We recreate the this.newInitialState object, else it's passed by reference and it causes problems
            this.problem.initial_states.push({ arg1: this.newInitialState.arg1, name: this.newInitialState.name, arg2: this.newInitialState.arg2, negate: this.newInitialState.negate });
            this.reevaluateArray('problem.initial_states', this.problem.initial_states);
            this.logActivity('4.1.4,add initial state:' + this.newInitialState.arg1.name + ' ' + this.newInitialState.name);

          } else {
            this.$.msgErrorNewPrecond.innerHTML = check.msg;
            this.$.errorNewPrecond.open();
          }
        } else if (condition == "GoalState") {
          // Check if the NOT-button is checked or no and update it
          this.newGoalState.negate = this.$.button_not_goal_state.checked;
          this.$.button_not_goal_state.checked = false;

          var check = this.checkPredicate("goal_state", this.newGoalState);
          if (check.valid) {
            this.problem.goal_states.push({ arg1: this.newGoalState.arg1, name: this.newGoalState.name, arg2: this.newGoalState.arg2, negate: this.newGoalState.negate });
            this.reevaluateArray('problem.goal_states', this.problem.goal_states);
            this._hasGoals = true;
            this.logActivity('4.2.1,add goal state:' + this.newGoalState.arg1.name + ' ' + this.newEffect.name);
          } else {
            this.$.msgErrorNewGoalState.innerHTML = check.msg;
            this.$.errorNewGoalState.open();
          }
        }
      },
      deletePred: function (evt) {
        var item = evt.model.item;
        console.debug('deletePred', item);
        var index = -1;
        index = this.problem.initial_states.indexOf(item);
        if (index != -1) {
          this.splice('problem.initial_states', index, 1);
          this.reevaluateArray('problem.initial_states', this.problem.initial_states);
          console.debug('deletePred from pre');
          this.logActivity('4.1.3,delete initial state:' + item.arg1.name + ' ' + item.name);

        } else {
          index = this.problem.goal_states.indexOf(item);
          if (index != -1) {
            this.splice('problem.goal_states', index, 1);
            this.reevaluateArray('problem.goal_states', this.problem.goal_states);
            if (this.problem.goal_states.length == 0)
              this._hasGoals = false;
            console.debug('deletePred from eff');
            this.logActivity('4.2.2,delete goal state:' + item.arg1.name + ' ' + item.name);

          }
        }
      },
      reevaluateArray: function (name, property) {
        var conds = property;
        this.set(name, []);
        this.set(name, conds);
      },
      _nameValid: function (name) {
        for (var i = 0; i < this.domain.problems.length; ++i) {
          if (this.domain.problems[i].name == name) return false;
        }
        return true;
      },

      _updateDomain: function (evt) {
        var msg = {
          type: 'update pddl domain',
          domain_id: this.domain_id,
          pddl_domain: this.domain
        };
        this.$.eventPub.publish(msg);
      },

      _domainUpdated: function (changedDomain) {
        if (changedDomain.value) {
          this.$.loading.close();
          this.domain = changedDomain.value;
          //updating the current problem
          var j = 0;
          while (j < this.domain.problems.length && this.domain.problems[j].name != this.problem.name) {
            j++;
          }
          if (j != this.domain.problems.length) {
            this.problem = this.domain.problems[j];
          }
          //show if no objects have been detected
          var i = 0;
          while (i < this.problem.objects.length
            && this.problem.objects[i].type.name == "position") {
            i++;
          }
          if (i != this.problem.objects.length) {
            this.$.noObj.style.display = "none";
          }
        }
      },


      _solve: function (evt) {
        console.debug("Solve problem ", this.problem);
        var msg = {
          type: 'solve pddl problem',
          domain_id: this.domain_id,
          planner: this.planner,
          pddl_problem: this.problem
        };
        this.$.eventPub.publish(msg);
        this.navStep = 'generatedPlan';
        this.logActivity('4.2.3,solve problem');

      },
      _execute: function (evt) {
        console.debug("Execute plan..", this.problem.generated_plan);

        var msg = {
          type: 'run pddl plan',
          domain_id: this.domain_id,
          pddl_problem: this.problem
        };
        this.$.eventPub.publish(msg);

        this.logActivity('4.3.2,execute plan');
      },

      _refreshViz: function (evt) {
        var msg = {
          type: 'refresh problem',
          domain_id: this.domain_id,
          pddl_problem: this.problem
        };
        console.debug('_refreshViz: ', this.problem);
        this.logActivity('4.0.1,refresh view');
        this.$.eventPub.publish(msg);
        this.load();
      },
      _detect: function (evt) {
        if (!this.ros) {
          console.error('Unable to call detection right now.');
          return;
        }
        var state = evt.target.getAttribute('data-args');
        var msg = {
          type: 'detect world state',
          domain_id: this.domain_id,
          problem_name: this.problem.name,
          state_name: state
        };
        console.debug(msg);
        this.$.loading.open();
        this.$.eventPub.publish(msg);
        console.debug("domaintopic is", this.$.domainTopic);
        this.logActivity('4.1.1,detect initial states: ' + state);

      },
      removeDuplicates: function (a) {
        uniqueArray = a.filter(function (item, pos) {
          return a.indexOf(item) == pos;
        });
      },

      _getParamTypeByName: function (obj) {
        // console.debug('_getParamTypeByName: ', item);

        for (var i = 0; i < this.problem.objects.length; ++i) {
          if (this.problem.objects[i].name == obj.name)
            return this.problem.objects[i].type.name;
        }
        return "?";
      },

      _getTypes: function (item) {
        var names = [];
        // console.debug('_getTypes: ', item);
        if (this.domain && this.domain.types) {
          for (var i = 0; i < this.domain.types.length; ++i) {
            names.push(this.domain.types[i].name);
          }
        }
        return (names);
      },


      _updateType: function (evt) {
        // this.reevaluateArray('action.params', this.action.params);
        console.debug("_updateType: ", evt.target);
        this.logActivity('4.1.2, change type to: ' + evt.target.name);
      },
      sortByName: function (arr) {
        arr.sort(function (a, b) {
          if (a.name < b.name) return -1;
          if (a.name > b.name) return 1;
          return 0;
        });
        return arr;
      },
      format: function (s) {
        s = s.toLowerCase();
        var len = s.length - 1;
        return s.substring(0, len) + s.substr(len).toUpperCase();
      },
      _parseArgs: function (step) {
        // translates string array to "english"
        var phrase = step.action.toLowerCase() + "(";
        // console.debug("_parseArgs: ", step);
        for (var i = 0; i < step.args.length; ++i) {
          phrase += this.format(step.args[i]) + ", ";
        }
        return phrase.slice(0, -2) + ")";
      },
      _displayNavStep: function (navStep, name) {
        return (navStep == name);
      },
      _selectNavStep: function (evt) {
        this.navStep = evt.target.getAttribute('data-args');
        this.save();
      },
      _negate: function (neg) {
        if (neg) return 'not ';
        else return '';
      },
      save: function () {
        if (this.problemName != this.problem.name && !this._nameValid(this.problemName)) {
          alert(this.problemName + ' already exists. Please choose a different name.');
        } else {
          var msg = {
            type: 'update pddl problem',
            domain_id: this.domain_id,
            problem_name: this.problemName,
            pddl_problem: this.problem
          };

          console.debug('Saving ', this.domain, " with name ", this.domain_id);
          console.debug('Saving ', this.problem, " with name ", this.problemName);
          this.$.eventPub.publish(msg);
          this.logActivity('4.0.2,save problem: ' + this.problem.name);
          if (this.problemName != this.problem.name) {
            this.logActivity('4.0.4,renamed problem to ' + this.problemName);
            this.quit();
          }
        }

      },
      quit: function (evt) {
        this.logActivity('4.0.3,quit problem: ' + this.problem.name);
        this.fire('quit');
      },
      saving: function (evt) {
        this.$.saving.open();
      },
      exiting: function (evt) {
        this.$.exiting.open();
      },
      displayIndex: function (index) {
        if (index < 1)
          this._stepsFound = false;
        return index + 1;

      },

      _getGeneralisedAction: function (action) {
        // returns action operator description with types:
        var text = action.name + "(";
        var paramList = "";
        for (var i = 0; i < Object.keys(action.params).length; ++i) {
          paramList += action.params[i].type.name.toUpperCase() + ", ";
        }
        return text + paramList.slice(0, -2) + ")";
      },
      _getTypeByName: function (name, list) {
        for (var i = 0; i < list.length; ++i) {
          var elem = list[i];
          if (elem.name == name)
            return elem.type;
        }
        return { name: "" };
      },
      viewActionSummary: function (evt) {
        var action = evt.model.action;
        var text = "<b>" + this._getGeneralisedAction(action) + "</b>";
        var pre = "<b>Preconditions:</b> <br>";
        for (var i = 0; i < action.preconditions.length; ++i) {
          var pred = action.preconditions[i];
          pre += this._getTypeByName(pred.arg1.name, action.params).name.toUpperCase() + ' is ' + pred.name;
          if (pred.arg2 && pred.arg2.name != "") {
            pre += ' ' + this._getTypeByName(pred.arg2.name, action.params).name.toUpperCase();
          }
          pre += '<br>';
        }
        var eff = "<b>Effects:</b> <br>";
        for (var i = 0; i < action.effects.length; ++i) {
          var pred = action.effects[i];
          eff += this._getTypeByName(pred.arg1.name, action.params).name.toUpperCase() + ' is ' + pred.name;
          if (pred.arg2 && pred.arg2.name != "") {
            eff += ' ' + this._getTypeByName(pred.arg2.name, action.params).name.toUpperCase();
          }
          eff += '<br>';
        }
        text += '<br><br>' + pre + '<br>' + eff;
        console.log("viewActionSummary: ", text);
        this.$.msgActionSummary.innerHTML = text;
        this.$.actionSummary.style.display = "inline";
      },

      viewInitialStates: function (evt) {
        var problem = this.problem;
        var text = "";
        for (var i = 0; i < problem.initial_states.length; ++i) {
          var pred = problem.initial_states[i];
          text += ' (' + pred.arg1.name + ') ' + pred.arg1.type.name.toUpperCase() + ' is ' + pred.name;
          if (pred.arg2 && pred.arg2.name != "") {
            text += ' ' + pred.arg2.type.name.toUpperCase() + ' (' + pred.arg2.name + ')';
          }
          text += '<br>';
        }
        console.log("viewInitialStates: ", text);
        this.$.msgInitalStatesSummary.innerHTML = text;
        this.$.initalStatesSummary.style.display = "inline";
      },

      viewGoalStates: function (evt) {
        var problem = this.problem;
        var text = "";
        for (var i = 0; i < problem.goal_states.length; ++i) {
          var pred = problem.goal_states[i];
          text += ' (' + pred.arg1.name + ') ' + this._getParamTypeByName(pred.arg1).toUpperCase() + ' is ' + pred.name;
          if (pred.arg2 && pred.arg2.name != "") {
            text += ' ' + this._getParamTypeByName(pred.arg2).toUpperCase() + ' (' + pred.arg2.name + ')';
          }
          text += '<br>';
        }
        console.log("viewGoalStates: ", text);
        this.$.msgGoalStatesSummary.innerHTML = text;
        this.$.goalStatesSummary.style.display = "inline";
      },
      showDebugging: function () {
        if (this._showDebugging)
          this._showDebugging = false;
        else {
          this._showDebugging = true;
          this.logActivity('4.3.1,show hints');
        }
      },

      logActivity: function (activity) {
        var now = new Date();
        var currentMenu = 'new-problem:' + this.problem.name;
        console.debug('[ACTIVITY-LOG]', now.toLocaleString(), ',',
          currentMenu, ',', activity);
        var msg = {
          type: 'log activity',
          domain_id: this.domain_id,
          domain_name: '',
          action_name: currentMenu,
          state_name: activity // use state_name as log description text
        };
        this.$.eventPub.publish(msg);
      }
    });
  </script>